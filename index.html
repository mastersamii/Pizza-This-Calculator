<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pizza This ‚Äî Order Calculator</title>
  <style>
    :root {
      /* Italian palette */
      --red: #d32f2f;
      --green: #2e7d32;
      --white: #ffffff;
      --ink: #1f2430;
      --muted: #5d677b;
      --border: #e5e7ef;
      --shadow: 0 10px 30px rgba(0,0,0,.08);

      --bg: #fafafa;
      --panel: #ffffff;
      --card: #ffffff;
      --chip: #f5f6fb;
      --text: var(--ink);
      --accent: var(--green);
      --radius: 16px;

      /* Dark theme tokens */
      --bg-dark:#0f1220; --panel-dark:#13172a; --card-dark:#171c33;
      --chip-dark:#222847; --text-dark:#e8ecf8; --border-dark:#2a3156;
    }
    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --card: var(--card-dark);
      --chip: var(--chip-dark);
      --text: var(--text-dark);
      --border: var(--border-dark);
    }
    * { box-sizing: border-box; }
    html, body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; }
    h1,h2,h3,h4{ font-family: Georgia, "Times New Roman", serif; letter-spacing:.2px; }

    .container{ max-width:1200px; margin:32px auto; padding:0 16px; }
    header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand .logo{ width:48px; height:48px; border-radius:12px; box-shadow:var(--shadow); position:relative; background:linear-gradient(135deg, var(--white) 0 33%, var(--green) 33% 66%, var(--red) 66% 100%); }
    .brand .logo::after{ content:"üçï"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px; }
    .brand h1{ margin:0; font-size:1.4rem; letter-spacing:.3px; }

    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:20px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
    .panel h2{ margin:0; padding:16px 18px; font-size:1rem; border-bottom:1px solid var(--border); }
    .panel .content{ padding:16px; }

    .section{ margin-bottom:16px; }
    .cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:8px; }
    .card h3{ margin:0; font-size:1rem; }
    .price{ color:var(--accent); font-weight:700; }
    .muted{ color:var(--muted); font-size:.9rem; }

    .qty{ display:grid; grid-template-columns:32px 1fr 32px; align-items:center; gap:8px; margin-top:6px; }
    .qty button{ height:36px; border-radius:10px; border:1px solid var(--border); background:var(--chip); color:var(--text); cursor:pointer; font-size:18px; }
    .qty output{ text-align:center; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--chip); color:var(--text); cursor:pointer; font-weight:600; text-decoration:none; }
    .btn.primary{ background:linear-gradient(135deg, var(--green), var(--red)); border:none; color:#fff; }
    .btn.block{ width:100%; }
    .btn.ghost{ background:transparent; }

    .toolrow{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .chip{ padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--muted); font-weight:700; font-size:.85rem; }

    .divider{ height:1px; background:var(--border); margin:8px 0; }
    .summary{ display:flex; flex-direction:column; gap:14px; }
    .summary .row{ display:flex; justify-content:space-between; align-items:center; }
    .summary .row.total{ font-size:1.2rem; font-weight:800; }

    .discount{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .discount input[type="range"]{ width:100%; }
    .kbd{ font-family: ui-monospace, Menlo, Consolas, monospace; background:transparent; border:2px solid #ff4d4d; color:#ff4d4d; border-radius:8px; padding:4px 8px; font-weight:800; }

    .order-card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:6px; }
    .cart-item{ display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; padding:8px; border-bottom:1px dashed var(--border); }
    .cart-item:last-child{ border-bottom:none; }
    .small{ font-size:.85rem; color:var(--muted); }

    .tabs{ display:flex; gap:8px; margin-bottom:10px; }
    .tabs .btn[aria-selected="true"]{ outline:2px solid var(--accent); }

    dialog{ width:min(720px,92vw); background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:18px; padding:0; box-shadow:var(--shadow); }
    dialog::backdrop{ background:rgba(0,0,0,.6); }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); }
    .modal-body{ padding:16px; display:grid; gap:18px; }
    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:700px){ .two-col{ grid-template-columns:1fr; } }
    .option{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .toppings{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:8px; }

    /* Ingredients list */
    .ing-list{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    .ing-actions{ display:flex; gap:8px; justify-content:flex-end; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Pizza This ‚Äî Order Calculator</h1>
          <div class="muted">Build pizzas, add deals & sides, apply discounts, and get an exact total.</div>
        </div>
      </div>
      <div class="toolrow">
        <span class="chip">Autosaves</span>
        <button class="btn ghost" id="themeBtn" aria-pressed="false" title="Toggle dark mode">üåô Dark</button>
        <button class="btn ghost" id="resetBtn">Clear All</button>
        <button class="btn primary" id="checkoutBtn">Checkout</button>
      </div>
    </header>

    <div class="flagbar" aria-hidden="true" style="height:10px;border-radius:8px;overflow:hidden;box-shadow:var(--shadow);margin-bottom:18px;">
      <div style="display:flex;height:100%;">
        <div style="flex:1;background:var(--green)"></div>
        <div style="flex:1;background:var(--white)"></div>
        <div style="flex:1;background:var(--red)"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Menu -->
      <section class="panel">
        <h2>Menu</h2>
        <div class="content">
          <div class="section">
            <div class="toolrow" style="justify-content:space-between;align-items:center">
              <h3 style="margin:0">Build Your Pizza</h3>
              <button class="btn" id="buildPizzaBtn">Customize + Add</button>
            </div>
            <div class="muted" style="margin-top:6px">Choose size, crust, and toppings. Price updates live.</div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Classic Pizzas</h3>
            <div class="cards" id="classic"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Specialty Pizzas</h3>
            <div class="cards" id="specialty"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Get Stuffed Deals</h3>
            <div class="cards" id="deals"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Meal Bundles</h3>
            <div class="cards" id="bundles"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Sides & Drinks</h3>
            <div class="cards" id="extras"></div>
          </div>
        </div>
      </section>

      <!-- Right: Orders -->
      <aside class="panel">
        <h2>Orders</h2>
        <div class="content">
          <div class="tabs" role="tablist" aria-label="Order panels">
            <button class="btn" data-tab="summary" aria-selected="true">üßæ Summary</button>
            <button class="btn" data-tab="history" aria-selected="false">üìú History</button>
            <button class="btn" data-tab="ingredients" aria-selected="false">üß∫ Ingredients</button>
          </div>

          <!-- SUMMARY TAB -->
          <div id="tab-summary" role="tabpanel">
            <div id="cart" class="order-card">
              <div class="cart-item muted">Your order is empty. Add a pizza or extra to get started.</div>
            </div>

            <div class="divider"></div>
            <div class="discount">
              <label for="discountRange">Discount</label>
              <div><span id="discountLabel" class="kbd">0%</span></div>
              <input id="discountRange" type="range" min="0" max="100" step="5" value="0" />
            </div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
              <div class="row"><span>Promotions</span><strong id="promotions">-$0.00</strong></div>
              <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
              <div class="small" id="promoNotes"></div>
            </div>

            <div class="right-actions" style="margin-top:12px;">
              <button class="btn primary block" id="checkoutBtn2">Checkout</button>
              <button class="btn ghost block" id="resetBtn2">Clear All</button>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div id="tab-history" role="tabpanel" hidden>
            <div class="summary" style="gap:8px; margin-bottom:8px;">
              <div class="row"><span>Orders served today</span><strong id="ordersToday">0</strong></div>
              <div class="row"><span>Orders served overall</span><strong id="ordersOverall">0</strong></div>
            </div>
            <div id="historyList" class="summary" style="gap:12px;"></div>
            <div class="right-actions" style="margin-top:12px;">
              <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>

          <!-- INGREDIENTS TAB -->
          <div id="tab-ingredients" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">Auto-aggregated from your current cart using each pizza's recipe and custom toppings.</div>
            <div id="ingredientList" class="order-card" style="padding:12px;">
              <div class="muted">No ingredients yet. Add items to the cart.</div>
            </div>
            <div class="ing-actions" style="margin-top:10px;">
              <button class="btn" id="copyIngBtn">Copy List</button>
              <button class="btn" id="exportIngBtn">Export CSV</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Build Pizza Modal -->
  <dialog id="pizzaModal">
    <div class="modal-header">
      <strong>Build Your Pizza</strong>
      <button class="btn" id="closeModal" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="two-col">
        <div>
          <h4 style="margin:0 0 8px 0;">Size</h4>
          <div id="sizeOptions"></div>
        </div>
        <div>
          <h4 style="margin:0 0 8px 0;">Crust</h4>
          <div id="crustOptions"></div>
        </div>
      </div>

      <div>
        <h4 style="margin:0 0 8px 0;">Toppings <span class="small">(priced per item)</span></h4>
        <div class="toppings" id="toppingOptions"></div>
      </div>

      <div class="two-col">
        <div class="option">
          <div>
            <div><strong>Quantity</strong></div>
            <div class="small">How many of this custom pizza?</div>
          </div>
          <div class="qty">
            <button id="qtyMinus">‚àí</button>
            <output id="qtyOutput">1</output>
            <button id="qtyPlus">+</button>
          </div>
        </div>
        <div class="option">
          <div>
            <div><strong>Current Price</strong></div>
            <div class="small">Auto-updates as you change options</div>
          </div>
          <div><strong id="livePrice">$0.00</strong></div>
        </div>
      </div>

      <div class="toolrow" style="justify-content:flex-end;">
        <button class="btn" id="addPizzaBtn">Add to Order</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Data ----------
    const MENU = {
      classic: [
        { id: 'cl-margh', name: 'üçÖüßÄüåø Margherita', price: 200, type:'pizza' },
        { id: 'cl-pepp',  name: 'üçï Pepperoni',      price: 200, type:'pizza' },
        { id: 'cl-salami',name: 'ü•© Salami',         price: 200, type:'pizza' },
        { id: 'cl-hamche',name: 'üê∑üßÄ Ham & Cheese',  price: 200, type:'pizza' },
      ],
      specialty: [
        { id: 'sp-veg',   name: 'ü•¶üçÑ Vegetarian',  price: 250, type:'pizza' },
        { id: 'sp-haw',   name: 'üçç Hawaiian',     price: 250, type:'pizza' },
        { id: 'sp-diav',  name: 'üå∂Ô∏è Diavola',      price: 250, type:'pizza' },
      ],
      deals: [
        { id: 'dl-classic', name: 'Get Stuffed ‚Äî Classic',   price: 800, type:'deal' },
        { id: 'dl-special', name: 'Get Stuffed ‚Äî Specialty', price: 1000, type:'deal' },
      ],
      bundles: [
        { id: 'bd-medium',      name: 'üçï Medium Pizza Meal ‚Äî 1 Classic + 4 Drinks',      price: 240, type:'bundle' },
        { id: 'bd-medium-spec', name: 'üçï Medium Pizza Meal ‚Äî 1 Specialty + 4 Drinks',    price: 290, type:'bundle' },
        { id: 'bd-large',       name: 'üçï Large Pizza Meal ‚Äî 2 Classic + 8 Drinks',       price: 450, type:'bundle' },
        { id: 'bd-large-spec',  name: 'üçï Large Pizza Meal ‚Äî 2 Specialty + 8 Drinks',     price: 500, type:'bundle' },
      ],
      extras: [
        { id: 'ex-bread', name: 'üßÑ Breadsticks', price: 50, type:'extra' },
        { id: 'ex-soda',  name: 'ü•§ Soda',        price: 10, type:'extra' },
        { id: 'ex-capri', name: 'üßÉ Capri-Sun',   price: 15, type:'extra' },
        { id: 'ex-water', name: 'üö∞ Water',       price: 10, type:'extra' },
        { id: 'ex-beer',  name: 'üç∫ Beer',        price: 18.50, type:'extra' },
        { id: 'ex-lunch', name: 'üç± Lunch Box',   price: 360, type:'extra' },
      ],
      builder: {
        sizes: [
          { id: 'sz-s',  name: 'Small 10"',  price: 120 },
          { id: 'sz-m',  name: 'Medium 12"', price: 160 },
          { id: 'sz-l',  name: 'Large 14"',  price: 200 },
          { id: 'sz-xl', name: 'XL 16"',     price: 240 },
        ],
        crusts: [
          { id: 'cr-hand', name: 'Hand Tossed', price: 0 },
          { id: 'cr-thin', name: 'Thin',        price: 10 },
          { id: 'cr-deep', name: 'Deep Dish',   price: 25 },
          { id: 'cr-gf',   name: 'Gluten Free', price: 30 },
        ],
        toppings: [
          { name: 'Pepperoni',   price: 8,  cat: 'Meats' },
          { name: 'Salami',      price: 8,  cat: 'Meats' },
          { name: 'Ham',         price: 8,  cat: 'Meats' },
          { name: 'Pineapple',   price: 6,  cat: 'Veggies' },
          { name: 'Jalape√±o',    price: 6,  cat: 'Veggies' },
          { name: 'Bell Pepper', price: 5,  cat: 'Veggies' },
          { name: 'Black Olive', price: 8,  cat: 'Veggies' },
          { name: 'Pizza Cheese', price: 4, cat: 'Cheeses' },
          { name: 'Mozzarella',   price: 10, cat: 'Cheeses' },
          { name: 'Tomato Sauce', price: 10, cat: 'Pantry' },
          { name: 'Olive Oil',    price: 8,  cat: 'Pantry' },
          { name: 'Yeast',        price: 10, cat: 'Pantry' },
          { name: 'Flour',        price: 6,  cat: 'Pantry' },
        ],
      }
    };

    // Recipe map with quantified ingredients per pizza. Keys must match menu IDs.
    // Use ingredient names from builder; synonyms are normalized in aggregation.
    const RECIPE_MAP = {
      // Classic
      'cl-margh': { 'Mozzarella':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-pepp' : { 'Pepperoni':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-salami': { 'Salami':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-hamche': { 'Ham':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      // Specialty
      'sp-veg'  : { 'Black Olive':2, 'Bell Pepper':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'sp-haw'  : { 'Pineapple':2, 'Ham':1, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'sp-diav' : { 'Pepperoni':1, 'Black Olive':1, 'Jalape√±o':1, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      // Extras
      'ex-bread': { 'Flour':1, 'Yeast':1, 'Olive Oil':1 },
    };

    const currency = n => `$${n.toFixed(2)}`;

    // ---------- State ----------
    const STATE_KEY = 'pizza_calc_state_v5';
    const HIST_KEY  = 'pizza_order_history_v5';
    const state = { cart: [], discountPct: 0, history: [] };
    try {
      const saved = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
      const savedHist = JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
      if (Array.isArray(savedHist)) state.history = savedHist;
      if (saved && Array.isArray(saved.cart)) { state.cart = saved.cart; state.discountPct = saved.discountPct || 0; }
    } catch {}
    const persist = () => localStorage.setItem(STATE_KEY, JSON.stringify({ cart: state.cart, discountPct: state.discountPct }));
    const persistHistory = () => localStorage.setItem(HIST_KEY, JSON.stringify(state.history));

    // ---------- Render Helpers ----------
    function cardHTML(item){
      return `
        <article class="card">
          <h3>${item.name}</h3>
          <div class="toolrow" style="justify-content:space-between;">
            <span class="price">${currency(item.price)}</span>
            <div class="qty">
              <button aria-label="decrease">‚àí</button>
              <output>1</output>
              <button aria-label="increase">+</button>
            </div>
          </div>
          <button class="btn" data-add="${item.id}">Add</button>
        </article>`;
    }
    function renderCards(){
      const classic = document.getElementById('classic');
      const specialty = document.getElementById('specialty');
      const deals = document.getElementById('deals');
      const bundles = document.getElementById('bundles');
      const extras = document.getElementById('extras');

      const make = arr => arr.map(cardHTML).join('');
      classic.innerHTML = make(MENU.classic);
      specialty.innerHTML = make(MENU.specialty);
      deals.innerHTML = make(MENU.deals);
      bundles.innerHTML = make(MENU.bundles);
      extras.innerHTML = make(MENU.extras);

      const allItems = [...MENU.classic, ...MENU.specialty, ...MENU.deals, ...MENU.bundles, ...MENU.extras];
      document.querySelectorAll('.cards .card').forEach(card=>{
        let count = 1;
        const out = card.querySelector('output');
        const minus = card.querySelector('button[aria-label="decrease"]');
        const plus  = card.querySelector('button[aria-label="increase"]');
        minus.addEventListener('click',()=>{ count=Math.max(1,count-1); out.value=count; });
        plus.addEventListener('click',()=>{ count++; out.value=count; });
        card.querySelector('[data-add]').addEventListener('click',()=>{
          const id = card.querySelector('[data-add]').getAttribute('data-add');
          const item = allItems.find(i=>i.id===id);
          addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:count, type:item.type });
        });
      });
    }

    function renderCart(){
      const cart = document.getElementById('cart');
      if (!state.cart.length){
        cart.innerHTML = `<div class="cart-item muted">Your order is empty. Add a pizza or extra to get started.</div>`;
        return;
      }
      cart.innerHTML = state.cart.map((l,idx)=>`
        <div class="cart-item">
          <div>
            <div><strong>${l.name}</strong></div>
            <div class="small">${currency(l.unitPrice)} each${l.meta?` ‚Ä¢ ${l.meta}`:''}</div>
          </div>
          <div class="qty">
            <button data-dec="${idx}">‚àí</button>
            <output>${l.qty}</output>
            <button data-inc="${idx}">+</button>
          </div>
            <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
        </div>`).join('');

      cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.getAttribute('data-inc'); state.cart[i].qty++; persist(); renderCart(); renderTotals(); renderIngredients(); }));
      cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.getAttribute('data-dec'); state.cart[i].qty--; if(state.cart[i].qty<=0) state.cart.splice(i,1); persist(); renderCart(); renderTotals(); renderIngredients(); }));
    }

    function addToCart(line){
      const key = `${line.id||line.name}|${line.unitPrice}|${line.type||''}`;
      const found = state.cart.find(l => `${l.id||l.name}|${l.unitPrice}|${l.type||''}` === key && (l.meta||'') === (line.meta||''));
      if (found) found.qty += line.qty; else state.cart.push(line);
      persist(); renderCart(); renderTotals(); renderIngredients();
    }

    // ---------- Promotions ----------
    function computePromotions(){
      const day = new Date().getDay(); // 0 Sun .. 6 Sat
      let notes = [];
      let discount = 0;

      // 1) Mon‚ÄìWed: Buy one pizza, get one half off (applies to pizzas incl. custom)
      if (day>=1 && day<=3){
        const unitPrices = [];
        state.cart.forEach(l=>{
          if (l.type === 'pizza' || l.name === 'Custom Pizza'){
            for(let i=0;i<l.qty;i++) unitPrices.push(l.unitPrice);
          }
        });
        if (unitPrices.length >= 2){
          unitPrices.sort((a,b)=>b-a); // high -> low
          for (let i=0;i<unitPrices.length; i+=2){
            const p1 = unitPrices[i];
            const p2 = unitPrices[i+1];
            if (typeof p2 === 'number') discount += p2 * 0.5;
          }
          if (discount>0) notes.push('Mon‚ÄìWed BOGO 50% on pizzas applied');
        }
      }

      // 2) Thu‚ÄìSat: Free breadsticks with any Get Stuffed deal (max 4 free per order)
      if (day>=4 && day<=6){
        const hasDealQty = state.cart.reduce((s,l)=> s + ((l.type==='deal')?l.qty:0), 0);
        if (hasDealQty>0){
          const bread = state.cart.find(l=>l.id==='ex-bread' || /breadsticks/i.test(l.name));
          if (bread){
            const freeQty = Math.min(4, bread.qty);
            if (freeQty>0){
              discount += freeQty * bread.unitPrice;
              notes.push(`Thu‚ÄìSat free breadsticks (${freeQty}) with Get Stuffed`);
            }
          }
        }
      }

      return { discount: +(discount.toFixed(2)), notes };
    }

    // ---------- Totals ----------
    function renderTotals(){
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const total = subtotal - manual - promo.discount;
      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('discount').textContent = `-${currency(manual)}`;
      document.getElementById('promotions').textContent = `-${currency(promo.discount)}`;
      document.getElementById('total').textContent = currency(total);
      document.getElementById('promoNotes').textContent = promo.notes.join(' ‚Ä¢ ');
    }

    // ---------- Discount slider ----------
    const range = document.getElementById('discountRange');
    const discountLabel = document.getElementById('discountLabel');
    function renderDiscount(){ range.value = state.discountPct; discountLabel.textContent = `${state.discountPct}%`; }
    range.addEventListener('input', ()=>{ state.discountPct = +range.value; persist(); renderTotals(); discountLabel.textContent = `${state.discountPct}%`; });

    // ---------- History ----------
    function ordersServedCounters(){
      const todayStr = new Date().toDateString();
      const today = state.history.filter(h=> new Date(h.id).toDateString() === todayStr).length;
      const overall = state.history.length;
      document.getElementById('ordersToday').textContent = today;
      document.getElementById('ordersOverall').textContent = overall;
    }

    function renderHistory(){
      ordersServedCounters();
      const list = document.getElementById('historyList');
      if (!state.history.length){ list.innerHTML = '<div class="muted">No past orders yet. Checkout to save one.</div>'; return; }
      list.innerHTML = state.history.map(h=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>${new Date(h.id).toLocaleString()}</strong></div>
              <div class="small">${h.items.length} item(s) ‚Ä¢ Discount ${h.discountPct}%</div>
            </div>
            <div><strong>${currency(h.total)}</strong></div>
          </div>
          <details class="small" style="margin-top:6px;">
            <summary>View items</summary>
            <ul style="margin:6px 0 0 16px;">
              ${h.items.map(i=>`<li>${i.qty}√ó ${i.name}${i.meta?` <span class=small>(${i.meta})</span>`:''} ‚Äî ${currency(i.lineTotal)}</li>`).join('')}
            </ul>
          </details>
          <div class="toolrow" style="justify-content:flex-end;">
            <button class="btn" data-reorder="${h.id}">Reorder</button>
            <button class="btn ghost" data-delete="${h.id}">Delete</button>
          </div>
        </article>
      `).join('');

      list.querySelectorAll('[data-reorder]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = +btn.getAttribute('data-reorder');
        const h = state.history.find(x=>x.id===id); if(!h) return;
        h.items.forEach(it => addToCart({ id: it.id || null, name: it.name, unitPrice: it.unit, qty: it.qty, meta: it.meta || null }));
      }));
      list.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = +btn.getAttribute('data-delete');
        state.history = state.history.filter(x=>x.id!==id); persistHistory(); renderHistory();
      }));
    }
    document.getElementById('clearHistoryBtn').addEventListener('click',()=>{ if(confirm('Clear all saved orders?')){ state.history=[]; persistHistory(); renderHistory(); ordersServedCounters(); } });

    // ---------- Tabs ----------
    const tabButtons = document.querySelectorAll('[data-tab]');
    function selectTab(which){
      document.getElementById('tab-summary').hidden = which!== 'summary';
      document.getElementById('tab-history').hidden = which!== 'history';
      document.getElementById('tab-ingredients').hidden = which!== 'ingredients';
      tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('data-tab')===which)));
      if (which==='ingredients') renderIngredients();
      if (which==='history') ordersServedCounters();
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>selectTab(b.getAttribute('data-tab'))));

    // ---------- Build Pizza Modal ----------
    const modal = document.getElementById('pizzaModal');
    const sizeWrap = document.getElementById('sizeOptions');
    const crustWrap = document.getElementById('crustOptions');
    const toppingWrap = document.getElementById('toppingOptions');
    const livePrice = document.getElementById('livePrice');
    const qtyOutput = document.getElementById('qtyOutput');

    const buildState = { size: MENU.builder.sizes[2], crust: MENU.builder.crusts[0], toppings: new Set(), qty: 1 };

    function renderBuilder(){
      sizeWrap.innerHTML = MENU.builder.sizes.map(s=>`
        <label class="option"><span>${s.name}</span>
          <span>${currency(s.price)} <input type="radio" name="size" value="${s.id}" ${s.id===buildState.size.id?'checked':''}></span>
        </label>`).join('');
      crustWrap.innerHTML = MENU.builder.crusts.map(c=>`
        <label class="option"><span>${c.name}</span>
          <span>${c.price?`+${currency(c.price)}`:'Included'} <input type="radio" name="crust" value="${c.id}" ${c.id===buildState.crust.id?'checked':''}></span>
        </label>`).join('');

      const groups = MENU.builder.toppings.reduce((acc,t)=>{ (acc[t.cat] ||= []).push(t); return acc; }, {});
      toppingWrap.innerHTML = Object.entries(groups).map(([cat,items])=>`
        <div>
          <h5 style="margin:6px 0">${cat}</h5>
          ${items.map(t=>`
            <label class="option"><span>${t.name}</span>
              <span>${currency(t.price)} <input type="checkbox" value="${t.name}" ${buildState.toppings.has(t.name)?'checked':''}></span>
            </label>`).join('')}
        </div>`).join('');

      sizeWrap.querySelectorAll('input[name="size"]').forEach(r=>r.addEventListener('change',e=>{ buildState.size = MENU.builder.sizes.find(s=>s.id===e.target.value); updateLivePrice(); }));
      crustWrap.querySelectorAll('input[name="crust"]').forEach(r=>r.addEventListener('change',e=>{ buildState.crust = MENU.builder.crusts.find(c=>c.id===e.target.value); updateLivePrice(); }));
      toppingWrap.querySelectorAll('input[type="checkbox"]').forEach(c=>c.addEventListener('change',e=>{ const v=e.target.value; if(e.target.checked) buildState.toppings.add(v); else buildState.toppings.delete(v); updateLivePrice(); }));
    }

    function calcPizzaPrice(){
      const base = buildState.size.price + buildState.crust.price;
      const tops = [...buildState.toppings].reduce((s,name)=>{
        const t = MENU.builder.toppings.find(x=>x.name===name); return s + (t?t.price:0);
      },0);
      return +(base + tops).toFixed(2);
    }
    function updateLivePrice(){ livePrice.textContent = currency(calcPizzaPrice() * buildState.qty); }

    document.getElementById('qtyMinus').addEventListener('click',()=>{ buildState.qty=Math.max(1,buildState.qty-1); qtyOutput.value=buildState.qty; updateLivePrice(); });
    document.getElementById('qtyPlus').addEventListener('click',()=>{ buildState.qty++; qtyOutput.value=buildState.qty; updateLivePrice(); });
    document.getElementById('buildPizzaBtn').addEventListener('click',()=>{ renderBuilder(); updateLivePrice(); modal.showModal(); });
    document.getElementById('closeModal').addEventListener('click',()=> modal.close());
    document.getElementById('addPizzaBtn').addEventListener('click',()=>{
      const unit = calcPizzaPrice();
      const metaTops = buildState.toppings.size?`, ${[...buildState.toppings].join(', ')}`:'';
      const meta = `${buildState.size.name}, ${buildState.crust.name}${metaTops}`;
      addToCart({ id:'custom', name:'Custom Pizza', unitPrice:unit, qty:buildState.qty, meta, type:'pizza' });
      buildState.qty = 1; qtyOutput.value = 1; updateLivePrice(); modal.close();
    });

    // ---------- Ingredients Aggregation ----------
    function parseCustomToppings(meta){
      if(!meta) return [];
      const parts = meta.split(',').map(s=>s.trim());
      return parts.slice(2); // skip size & crust
    }

    function aggregateIngredients(){
      const tally = {};
      const add = (name, n=1)=>{ if(!name) return; tally[name] = (tally[name]||0)+n; };

      const normalize = (name)=>{
        const map = {
          'Olive':'Black Olive',
          'Olives':'Black Olive',
          'Jalapeno':'Jalape√±o',
          'Bell Pepper Slice':'Bell Pepper',
          'Margarita':'Margherita',
        };
        return map[name] || name;
      };

      const addDough = (units)=>{
        add('Olive Oil', 1*units);
        add('Flour', 1*units);
        add('Yeast', 1*units);
      };

      const applyRecipe = (recipeDict, qty)=>{
        Object.entries(recipeDict).forEach(([ing,count])=>{
          if (ing === 'Dough') { addDough(count*qty); }
          else { add(normalize(ing), count*qty); }
        });
      };

      state.cart.forEach(line=>{
        if(line.type==='pizza' && line.id && RECIPE_MAP[line.id]){
          applyRecipe(RECIPE_MAP[line.id], line.qty);
        } else if(line.name==='Custom Pizza'){
          const tops = parseCustomToppings(line.meta).map(normalize);
          tops.forEach(ing=> add(ing, line.qty));
          addDough(1*line.qty);
          add('Tomato Sauce', 1*line.qty);
          add('Pizza Cheese', 1*line.qty);
        } else if(line.id && RECIPE_MAP[line.id]){
          applyRecipe(RECIPE_MAP[line.id], line.qty);
        }
      });
      return tally;
    }

    function renderIngredients(){
      const wrap = document.getElementById('ingredientList');
      const tally = aggregateIngredients();
      const entries = Object.entries(tally).sort((a,b)=> a[0].localeCompare(b[0]));
      if(entries.length===0){ wrap.innerHTML = '<div class="muted">No ingredients yet. Add items to the cart.</div>'; return; }
      wrap.innerHTML = entries.map(([name,count])=>`<div class="ing-list"><div>${name}</div><div><strong>x${count}</strong></div></div>`).join('');
    }

    // Copy / Export actions
    document.getElementById('copyIngBtn').addEventListener('click',()=>{
      const tally = aggregateIngredients();
      const txt = Object.entries(tally).sort((a,b)=>a[0].localeCompare(b[0])).map(([n,c])=>`- ${n} x${c}`).join('\n');
      navigator.clipboard.writeText(txt).then(()=>{
        alert('Ingredients copied to clipboard!');
      });
    });

    document.getElementById('exportIngBtn').addEventListener('click',()=>{
      const tally = aggregateIngredients();
      const rows = [['Ingredient','Count'], ...Object.entries(tally).sort((a,b)=>a[0].localeCompare(b[0]))];
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ingredients.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // ---------- Discount & Tabs ----------
    function renderAll(){ renderCards(); renderCart(); renderTotals(); renderDiscount(); renderHistory(); }

    // ---------- Checkout / Reset ----------
    function checkout(){
      if (!state.cart.length){ alert('Your order is empty.'); return; }
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const total = +(subtotal - manual - promo.discount).toFixed(2);
      const entry = {
        id: Date.now(),
        items: state.cart.map(l=>({ id: l.id || null, name:l.name, qty:l.qty, unit:l.unitPrice, meta:l.meta||null, lineTotal:+(l.unitPrice*l.qty).toFixed(2) })),
        discountPct: state.discountPct,
        subtotal:+subtotal.toFixed(2),
        discount: manual + promo.discount,
        total
      };
      state.history.unshift(entry); persistHistory();
      state.cart = []; state.discountPct = 0; persist();
      renderAll(); selectTab('history'); ordersServedCounters();
    }
    function resetAll(){ state.cart = []; state.discountPct = 0; persist(); renderAll(); renderIngredients(); }

    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('checkoutBtn2').addEventListener('click', checkout);
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('resetBtn2').addEventListener('click', resetAll);

    // ---------- Theme ----------
    const themeBtn = document.getElementById('themeBtn');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('pizza_theme', t);
      themeBtn.textContent = t==='dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      themeBtn.setAttribute('aria-pressed', t==='dark');
    }
    applyTheme(localStorage.getItem('pizza_theme') || 'light');
    themeBtn.addEventListener('click',()=>{ const next = (localStorage.getItem('pizza_theme')||'light')==='light' ? 'dark' : 'light'; applyTheme(next); });

    // ---------- Init ----------
    renderAll();
  </script>
</body>
</html>
