<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pizza This Order Calculator</title>
  <style>
    :root {
      /* Italian palette */
      --red: #d32f2f;
      --green: #2e7d32;
      --white: #ffffff;
      --ink: #1f2430;
      --muted: #5d677b;
      --border: #e5e7ef;
      --shadow: 0 10px 30px rgba(0,0,0,.08);

      --bg: #fafafa;
      --panel: #ffffff;
      --card: #ffffff;
      --chip: #f5f6fb;
      --text: var(--ink);
      --accent: var(--green);
      --radius: 16px;

      /* Dark theme tokens */
      --bg-dark:#0f1220; --panel-dark:#13172a; --card-dark:#171c33;
      --chip-dark:#222847; --text-dark:#e8ecf8; --border-dark:#2a3156;
    }
    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --card: var(--card-dark);
      --chip: var(--chip-dark);
      --text: var(--text-dark);
      --border: var(--border-dark);
    }
    * { box-sizing: border-box; }
    html, body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; }
    h1,h2,h3,h4{ font-family: Georgia, "Times New Roman", serif; letter-spacing:.2px; }

    .container{ max-width:1200px; margin:32px auto; padding:0 16px; }
    header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand .logo{ width:48px; height:48px; border-radius:12px; box-shadow:var(--shadow); position:relative; background:linear-gradient(135deg, var(--white) 0 33%, var(--green) 33% 66%, var(--red) 66% 100%); }
    .brand .logo::after{ content:"üçï"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px; }
    .brand h1{ margin:0; font-size:1.4rem; letter-spacing:.3px; }

    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:20px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); }
    .panel h2{ margin:0; padding:16px 18px; font-size:1rem; border-bottom:1px solid var(--border); }
    .panel .content{ padding:16px; }

    .section{ margin-bottom:16px; }
    .cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .card h3{ margin:0; font-size:1rem; }
    .price{ color:var(--accent); font-weight:700; }
    .muted{ color:var(--muted); font-size:.9rem; }

    .qty{ display:grid; grid-template-columns:32px 1fr 32px; align-items:center; gap:8px; margin-top:6px; }
    .qty button{ height:36px; border-radius:10px; border:1px solid var(--border); background:var(--chip); color:var(--text); cursor:pointer; font-size:18px; }
    .qty output{ text-align:center; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--chip); color:var(--text); cursor:pointer; font-weight:600; text-decoration:none; }
    .btn.primary{ background:linear-gradient(135deg, var(--green), var(--red)); border:none; color:#fff; }
    .btn.block{ width:100%; }
    .btn.ghost{ background:transparent; }

    .toolrow{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .chip{ padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--muted); font-weight:700; font-size:.85rem; }

    .divider{ height:1px; background:var(--border); margin:8px 0; }
    .summary{ display:flex; flex-direction:column; gap:14px; }
    .summary .row{ display:flex; justify-content:space-between; align-items:center; }
    .summary .row.total{ font-size:1.2rem; font-weight:800; }

    .discount{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .discount input[type="range"]{ width:100%; }
    .kbd{ font-family: ui-monospace, Menlo, Consolas, monospace; background:transparent; border:2px solid #ff4d4d; color:#ff4d4d; border-radius:8px; padding:4px 8px; font-weight:800; }

    .order-card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:6px; }
    .cart-item{ display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; padding:8px; border-bottom:1px dashed var(--border); }
    .cart-item:last-child{ border-bottom:none; }
    .small{ font-size:.85rem; color:var(--muted); }

    .tabs{ display:flex; gap:8px; margin-bottom:10px; }
    .tabs .btn[aria-selected="true"]{ outline:2px solid var(--accent); }

    dialog{ width:min(760px,92vw); background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:18px; padding:0; }
    dialog::backdrop{ background:rgba(0,0,0,.6); }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); }
    .modal-body{ padding:16px; display:grid; gap:18px; }
    .option{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card); }

    /* Selector grid for pizzas/drinks */
    .selector-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; }
    .select-card{ border:1px solid var(--border); background:var(--card); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .select-title{ font-weight:700; }
    .select-qty{ display:grid; grid-template-columns:32px 1fr 32px; align-items:center; gap:8px; }
    .select-qty button{ height:32px; border-radius:8px; border:1px solid var(--border); background:var(--chip); }

    /* Ingredients list */
    .ing-list{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    .ing-actions{ display:flex; gap:8px; justify-content:flex-end; }

    /* Loyalty tray */
    .punchtray{display:flex;gap:8px;flex-wrap:wrap}
    .chipbox{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:var(--chip);border:1px dashed #cad0e4}
    .chipbox.filled{background:repeating-conic-gradient(from 0deg, var(--green) 0 20%, #2c6d30 0 40%);border:none;color:#fff}
    .chipbox.free{border:1px solid var(--green)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Pizza This Order Calculator</h1>
          <div class="muted">Pick pizzas, add deals & sides, apply discounts, and get an exact total.</div>
        </div>
      </div>
      <div class="toolrow">
        <span class="chip">Autosaves</span>
        <button class="btn ghost" id="themeBtn" aria-pressed="false" title="Toggle dark mode">üåô Dark</button>
        <button class="btn ghost" id="resetBtn">Clear All</button>
        <button class="btn primary" id="checkoutBtn">Checkout</button>
      </div>
    </header>

    <div class="flagbar" aria-hidden="true" style="height:10px;border-radius:8px;overflow:hidden;margin-bottom:18px;">
      <div style="display:flex;height:100%;">
        <div style="flex:1;background:var(--green)"></div>
        <div style="flex:1;background:var(--white)"></div>
        <div style="flex:1;background:var(--red)"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Menu -->
      <section class="panel">
        <h2>Menu</h2>
        <div class="content">
          <div class="section">
            <h3 style="margin:0 0 8px 0">Classic Pizzas</h3>
            <div class="cards" id="classic"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Specialty Pizzas</h3>
            <div class="cards" id="specialty"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Get Stuffed Deals</h3>
            <div class="cards" id="deals"></div>
          </div>

          <!-- Pizza Pack section -->
          <div class="section">
            <h3 style="margin:0 0 8px 0">Pizza Pack</h3>
            <div class="cards" id="packs"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Meal Bundles</h3>
            <div class="cards" id="bundles"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Sides & Drinks</h3>
            <div class="cards" id="extras"></div>
          </div>
        </div>
      </section>

      <!-- Right: Orders -->
      <aside class="panel">
        <h2>Orders</h2>
        <div class="content">
          <div class="tabs" role="tablist" aria-label="Order panels">
            <button class="btn" data-tab="summary" aria-selected="true">üßæ Summary</button>
            <button class="btn" data-tab="history" aria-selected="false">üìú History</button>
            <button class="btn" data-tab="ingredients" aria-selected="false">üß∫ Ingredients</button>
            <button class="btn" data-tab="loyalty" aria-selected="false">‚≠ê Loyalty</button>
          </div>

          <!-- SUMMARY TAB -->
          <div id="tab-summary" role="tabpanel">
            <div class="option" style="margin-bottom:10px;">
              <div>
                <div><strong>Fulfillment</strong></div>
                <div class="small">City $50 ¬∑ Sandy $100 ¬∑ Paleto $150</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <label><input type="radio" name="fulfill" value="pickup"> Pickup</label>
                <label><input type="radio" name="fulfill" value="delivery"> Delivery</label>
                <select id="zoneSelect" style="margin-left:6px;">
                  <option value="city">City</option>
                  <option value="sandy">Sandy</option>
                  <option value="paleto">Paleto</option>
                </select>
              </div>
            </div>

            <div id="cart" class="order-card">
              <div class="cart-item muted">Your order is empty. Add a pizza or extra to get started.</div>
            </div>

            <div class="divider"></div>

            <!-- Pizza Saver Sunday -->
            <div class="option" id="saverSection" style="margin-bottom:10px;">
              <div>
                <div><strong>Pizza Saver Sunday</strong></div>
                <div class="small" id="saverHelp">Each saver knocks $50 off (Sundays only)</div>
              </div>
              <div class="toolrow">
                <span class="chip" id="saverChip">Savers: 0 (‚àí$50 ea)</span>
                <button class="btn" id="addSaverBtn">Add Pizza Saver</button>
                <button class="btn ghost" id="removeSaverBtn">Remove Saver</button>
                <button class="btn ghost" id="clearSaverBtn">Clear</button>
              </div>
            </div>

            <div class="discount">
              <label for="discountRange">Discount</label>
              <div><span id="discountLabel" class="kbd">0%</span></div>
              <input id="discountRange" type="range" min="0" max="100" step="5" value="0" />
            </div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row" id="deliveryRow" style="display:none;"><span>Delivery Fee</span><strong id="deliveryFee">$0.00</strong></div>
              <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
              <div class="row"><span>Promotions</span><strong id="promotions">-$0.00</strong></div>
              <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
              <div class="small" id="promoNotes"></div>
            </div>

            <div class="right-actions" style="margin-top:12px;">
              <button class="btn primary block" id="checkoutBtn2">Checkout</button>
              <button class="btn ghost block" id="resetBtn2">Clear All</button>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div id="tab-history" role="tabpanel" hidden>
            <div class="summary" style="gap:8px; margin-bottom:8px;">
              <div class="row"><span>Orders served today</span><strong id="ordersToday">0</strong></div>
              <div class="row"><span>Orders served overall</span><strong id="ordersOverall">0</strong></div>
            </div>
            <div id="historyList" class="summary" style="gap:12px;"></div>
            <div class="right-actions" style="margin-top:12px;">
              <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>

          <!-- INGREDIENTS TAB -->
          <div id="tab-ingredients" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">Auto-aggregated from your current cart using each pizza's recipe and your bundle selections.</div>
            <div id="ingredientList" class="order-card" style="padding:12px;">
              <div class="muted">No ingredients yet. Add items to the cart.</div>
            </div>
            <div class="ing-actions" style="margin-top:10px;">
              <button class="btn" id="copyIngBtn">Copy List</button>
              <button class="btn" id="exportIngBtn">Export CSV</button>
            </div>
          </div>

          <!-- LOYALTY TAB -->
          <div id="tab-loyalty" role="tabpanel" hidden>
            <div class="option" style="margin-bottom:10px;">
              <div>
                <div><strong>Loyalty Manager</strong></div>
                <div class="small">10 punches. 10th is free ‚Üí Large Meal (2 pizzas + 8 drinks + 2 breadsticks).</div>
                <div class="small" id="dpStatus">Double Punch Tuesday:(ACTIVE only on Tuesdays)</div>
              </div>
              <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;align-items:end;max-width:860px">
                <div>
                  <label class="small muted">Player / Citizen ID</label>
                  <input id="loy-player" placeholder="citizen_123 or name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#000" />
                </div>
                <button class="btn primary" id="loy-add">Add Punch</button>
                <div style="text-align:right">
                  <div class="small muted">Visit</div>
                  <div class="toolrow" style="justify-content:flex-end">
                    <span class="chip" id="visitInfo">#1 ‚Ä¢ 0 punched</span>
                    <button class="btn" id="newVisitBtn" title="Start a new visit (resets per-visit limits)">New Visit</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="order-card" style="padding:12px;margin-bottom:10px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <div>
                  <div class="small muted">Punch Card</div>
                  <div id="loy-tray" class="punchtray" aria-live="polite"></div>
                </div>
                <div class="toolrow">
                  <button class="btn" id="loy-undo">-1 Punch</button>
                  <button class="btn" id="loy-redeem">Redeem Reward ‚Üí Pick Meal</button>
                </div>
              </div>
              <div id="loy-status" class="small muted" style="margin-top:6px;">‚Äî</div>
            </div>

            <div class="order-card" style="padding:0;">
              <div style="padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <strong>Customers</strong>
                <div class="small muted" id="loy-stats">Players: 0 ‚Ä¢ Rewards banked: 0</div>
              </div>
              <div style="padding:12px;">
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr><th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Player</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Punches</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Rewards</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Last</th>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)"></th></tr>
                  </thead>
                  <tbody id="loy-body"></tbody>
                </table>
              </div>
              <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="loy-export">Export JSON</button>
              </div>
            </div>
          </div>
          <!-- /LOYALTY TAB -->
        </div>
      </aside>
    </div>
  </div>

  <!-- Combo/Bundle Selector Modal -->
  <dialog id="comboModal">
    <div class="modal-header">
      <strong id="comboTitle">Choose Pizzas</strong>
      <button class="btn" id="closeCombo" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="comboSteps"></div>
      <div id="comboContent"></div>
      <div class="toolrow" style="justify-content:flex-end; margin-top:6px;">
        <button class="btn" id="comboPrev" style="display:none;">Back</button>
        <button class="btn primary" id="comboNext">Next</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Data ----------
    const MENU = {
      classic: [
        { id: 'cl-margh', name: 'üçÖüßÄüåø Margherita', price: 200, type:'pizza' },
        { id: 'cl-pepp',  name: 'üçï Pepperoni',      price: 200, type:'pizza' },
        { id: 'cl-salami',name: 'ü•© Salami',         price: 200, type:'pizza' },
        { id: 'cl-hamche',name: 'üê∑üßÄ Ham',  price: 200, type:'pizza' },
      ],
      specialty: [
        { id: 'sp-veg',   name: 'ü•¶üçÑ Vegetarian',  price: 250, type:'pizza' },
        { id: 'sp-haw',   name: 'üçç Hawaiian',     price: 250, type:'pizza' },
        { id: 'sp-diav',  name: 'üå∂Ô∏è Diavola',      price: 250, type:'pizza' },
      ],
      deals: [
        { id: 'dl-classic', name: 'Get Stuffed: Classic',   price: 800, type:'deal',   pizzasIncluded:4, allow:'classic',   drinksIncluded:16 },
        { id: 'dl-special', name: 'Get Stuffed: Specialty', price: 1000, type:'deal',  pizzasIncluded:4, allow:'specialty', drinksIncluded:16 },
      ],
      packs: [
        { id: 'bd-pack', name: 'üç± Pizza Pack', price: 700, type:'bundle',
          pizzasIncluded:2, allow:'both', drinksIncluded:8,
          surchargeSpecialty:50, includesLunchbox:true,
          description:'2 classic pizzas + 8 drinks packed in your own Pizza This Lunchbox. First time includes the box.' },
        { id: 'bd-pack-refill', name: 'üç± Pizza Pack Refill', price: 350, type:'bundle',
          pizzasIncluded:2, allow:'both', drinksIncluded:8,
          surchargeSpecialty:50, isRefill:true,
          description:'Bring your box back and load it up again. Save $100 every time you refill the Pizza Pack. $50 extra for specialty pizzas.' },
      ],
      bundles: [
        { id: 'bd-medium',      name: 'üçï Medium Pizza Meal: 1 Classic + 4 Drinks',   price: 240, type:'bundle', pizzasIncluded:1, allow:'classic',   drinksIncluded:4 },
        { id: 'bd-medium-spec', name: 'üçï Medium Pizza Meal: 1 Specialty + 4 Drinks', price: 340, type:'bundle', pizzasIncluded:1, allow:'specialty', drinksIncluded:4 },
        { id: 'bd-large',       name: 'üçï Large Pizza Meal: 2 Classic + 8 Drinks',    price: 450, type:'bundle', pizzasIncluded:2, allow:'classic',   drinksIncluded:8 },
        { id: 'bd-large-spec',  name: 'üçï Large Pizza Meal: 2 Specialty + 8 Drinks',  price: 550, type:'bundle', pizzasIncluded:2, allow:'specialty', drinksIncluded:8 },
      ],
      extras: [
        { id: 'ex-bread', name: 'üßÑ Breadsticks', price: 50, type:'extra' },
        { id: 'ex-soda',  name: 'ü•§ Soda',        price: 40, type:'extra', isDrink:true },
        { id: 'ex-capri', name: 'üßÉ Capri-Sun',   price: 45, type:'extra', isDrink:true },
        { id: 'ex-water', name: 'üö∞ Water',       price: 40, type:'extra', isDrink:true },
        { id: 'ex-beer',  name: 'üç∫ Beer',        price: 55, type:'extra', isDrink:true },
        { id: 'ex-lunch', name: 'üç± Lunch Box',   price: 360, type:'extra' },
      ],
    };

    // Recipe map
    const RECIPE_MAP = {
      'cl-margh': { 'Mozzarella':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-pepp' : { 'Pepperoni':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-salami': { 'Salami':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'cl-hamche': { 'Ham':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'sp-veg'  : { 'Black Olive':2, 'Bell Pepper':2, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'sp-haw'  : { 'Pineapple':2, 'Ham':1, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'sp-diav' : { 'Pepperoni':1, 'Black Olive':1, 'Jalape√±o':1, 'Tomato Sauce':1, 'Pizza Cheese':1, 'Dough':1 },
      'ex-bread': { 'Flour':1, 'Yeast':1, 'Olive Oil':1 },
    };

    const currency = n => `$${n.toFixed(2)}`;

    // ---------- State ----------
    const STATE_KEY = 'pizza_calc_state_v10';
    const HIST_KEY  = 'pizza_order_history_v5';

    const state = {
      cart: [],
      discountPct: 0,
      history: [],
      fulfillment: 'pickup',
      deliveryZone: 'city',
      pizzaSavers: 0
    };

    try {
      const saved = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
      const savedHist = JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
      if (Array.isArray(savedHist)) state.history = savedHist;
      if (saved) {
        if (Array.isArray(saved.cart)) state.cart = saved.cart;
        if (typeof saved.discountPct === 'number') state.discountPct = saved.discountPct;
        if (saved.fulfillment) state.fulfillment = saved.fulfillment;
        if (saved.deliveryZone) state.deliveryZone = saved.deliveryZone;
        if (typeof saved.pizzaSavers === 'number') state.pizzaSavers = saved.pizzaSavers;
      }
    } catch {}

    const persist = () =>
      localStorage.setItem(STATE_KEY, JSON.stringify({
        cart: state.cart,
        discountPct: state.discountPct,
        fulfillment: state.fulfillment,
        deliveryZone: state.deliveryZone,
        pizzaSavers: state.pizzaSavers
      }));
    const persistHistory = () => localStorage.setItem(HIST_KEY, JSON.stringify(state.history));

    // ---------- Helpers ----------
    function findMenuItem(id){
      const pools = [MENU.classic, MENU.specialty, MENU.deals, MENU.packs, MENU.bundles, MENU.extras];
      for (const pool of pools){ const f = pool.find(x=>x.id===id); if (f) return f; }
      return null;
    }
    function getDrinkPool(){ return MENU.extras.filter(x=>x.isDrink); }
    function getPizzaPool(allow){
      if (allow==='specialty') return MENU.specialty;
      if (allow==='both') return [...MENU.classic, ...MENU.specialty];
      return MENU.classic;
    }
    // Helper: is this pizza id a specialty?
    function isSpecialtyId(pid){
      return MENU.specialty.some(p => p.id === pid);
    }

    // ---------- Cards ----------
    function cardHTML(item){
      const needsCombo = (item.pizzasIncluded||0) > 0 || (item.drinksIncluded||0) > 0;
      return `
        <article class="card">
          <h3>${item.name}</h3>
          <div class="toolrow" style="justify-content:space-between;">
            <span class="price">${currency(item.price)}</span>
            <div class="qty">
              <button aria-label="decrease">‚àí</button>
              <output>1</output>
              <button aria-label="increase">+</button>
            </div>
          </div>
          ${
            needsCombo
              ? `<button class="btn" data-wizard="${item.id}">Choose &amp; Add</button>`
              : `<button class="btn" data-add="${item.id}">Add</button>`
          }
        </article>`;
    }

    function renderCards(){
      const classic = document.getElementById('classic');
      const specialty = document.getElementById('specialty');
      const deals = document.getElementById('deals');
      const packs = document.getElementById('packs');
      const bundles = document.getElementById('bundles');
      const extras = document.getElementById('extras');

      const make = arr => arr.map(cardHTML).join('');
      classic.innerHTML = make(MENU.classic);
      specialty.innerHTML = make(MENU.specialty);
      deals.innerHTML = make(MENU.deals);
      packs.innerHTML = make(MENU.packs);
      bundles.innerHTML = make(MENU.bundles);
      extras.innerHTML = make(MENU.extras);

      const allItems = [
        ...MENU.classic, ...MENU.specialty, ...MENU.deals,
        ...MENU.packs, ...MENU.bundles, ...MENU.extras
      ];

      document.querySelectorAll('.cards .card').forEach(card=>{
        let count = 1;
        const out = card.querySelector('output');
        const minus = card.querySelector('button[aria-label="decrease"]');
        const plus  = card.querySelector('button[aria-label="increase"]');
        minus?.addEventListener('click',()=>{ count=Math.max(1,count-1); out.value=count; });
        plus?.addEventListener('click',()=>{ count++; out.value=count; });

        const wizId = card.querySelector('[data-wizard]')?.getAttribute('data-wizard');
        if (wizId){
          const item = allItems.find(i=>i.id===wizId);
          card.querySelector('[data-wizard]').addEventListener('click', ()=> openComboWizard(item, count));
          return;
        }

        const addId = card.querySelector('[data-add]')?.getAttribute('data-add');
        if (addId){
          const item = allItems.find(i=>i.id===addId);
          card.querySelector('[data-add]').addEventListener('click',()=>{
            addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:count, type:item.type });
          });
        }
      });
    }

    // ---------- Cart ----------
    function renderCart(){
      const cart = document.getElementById('cart');
      if (!state.cart.length){
        cart.innerHTML = `<div class="cart-item muted">Your order is empty. Add a pizza or extra to get started.</div>`;
        return;
      }
      cart.innerHTML = state.cart.map((l,idx)=>`
        <div class="cart-item">
          <div>
            <div><strong>${l.name}</strong></div>
            <div class="small">${currency(l.unitPrice)} each${l.meta?` ‚Ä¢ ${l.meta}`:''}</div>
          </div>
          <div class="qty">
            <button data-dec="${idx}">‚àí</button>
            <output>${l.qty}</output>
            <button data-inc="${idx}">+</button>
          </div>
          <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
        </div>`).join('');

      cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.getAttribute('data-inc'); state.cart[i].qty++; persist(); renderCart(); renderTotals(); renderIngredients(); }));
      cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.getAttribute('data-dec'); state.cart[i].qty--; if(state.cart[i].qty<=0) state.cart.splice(i,1); persist(); renderCart(); renderTotals(); renderIngredients(); }));
    }

    function addToCart(line){
      const key = `${line.id||line.name}|${line.unitPrice}|${line.type||''}|${(line.meta||'')}`;
      const found = state.cart.find(l =>
        `${l.id||l.name}|${l.unitPrice}|${l.type||''}|${(l.meta||'')}` === key &&
        JSON.stringify(l.combo||[])===JSON.stringify(line.combo||[]) &&
        JSON.stringify(l.drinks||{})===JSON.stringify(line.drinks||{})
      );
      if (found) found.qty += line.qty; else state.cart.push(line);
      persist(); renderCart(); renderTotals(); renderIngredients();
    }

    // ---------- Fulfillment ----------
    const ZONE_FEES = { city:50, sandy:100, paleto:150 };

    function renderFulfillment(){
      const radios = document.querySelectorAll('input[name="fulfill"]');
      radios.forEach(r => r.checked = (r.value === state.fulfillment));
      const zoneSel = document.getElementById('zoneSelect');
      zoneSel.value = state.deliveryZone;
      zoneSel.disabled = state.fulfillment !== 'delivery';
    }

    document.querySelectorAll('input[name="fulfill"]').forEach(r=>{
      r.addEventListener('change', e=>{
        state.fulfillment = e.target.value;
        persist(); renderFulfillment(); renderTotals();
      });
    });
    document.getElementById('zoneSelect').addEventListener('change', e=>{
      state.deliveryZone = e.target.value;
      persist(); renderTotals();
    });

    // ---------- Pizza Saver Sunday ----------
    function isSunday(){ return new Date().getDay() === 0; }
    function renderPizzaSaver(){
      const chip = document.getElementById('saverChip');
      chip.textContent = `Savers: ${state.pizzaSavers} (‚àí$50 ea)`;
      const addBtn = document.getElementById('addSaverBtn');
      const rmBtn = document.getElementById('removeSaverBtn');
      const clrBtn = document.getElementById('clearSaverBtn');
      const help = document.getElementById('saverHelp');

      if (isSunday()){
        addBtn.disabled = false;
        help.textContent = 'Each saver knocks $50 off (Sundays only)';
      } else {
        addBtn.disabled = true;
        help.textContent = 'Unavailable today (Sundays only)';
      }

      const has = state.pizzaSavers > 0;
      rmBtn.disabled = !has;
      clrBtn.disabled = !has;
    }
    document.getElementById('addSaverBtn').addEventListener('click', ()=>{
      if (!isSunday()) return;
      state.pizzaSavers += 1;
      persist(); renderPizzaSaver(); renderTotals();
    });
    document.getElementById('removeSaverBtn').addEventListener('click', ()=>{
      if (state.pizzaSavers > 0) {
        state.pizzaSavers -= 1;
        persist(); renderPizzaSaver(); renderTotals();
      }
    });
    document.getElementById('clearSaverBtn').addEventListener('click', ()=>{
      if (state.pizzaSavers > 0) {
        state.pizzaSavers = 0;
        persist(); renderPizzaSaver(); renderTotals();
      }
    });

    // ---------- Promotions ----------
    function computePromotions(){
      const day = new Date().getDay(); // 0 Sun .. 6 Sat
      let notes = [];
      let discount = 0;

      // Mon‚ÄìWed: BOGO 50% on pizzas
      if (day>=1 && day<=3){
        const unitPrices = [];
        state.cart.forEach(l=>{ if (l.type === 'pizza'){ for(let i=0;i<l.qty;i++) unitPrices.push(l.unitPrice); } });
        if (unitPrices.length >= 2){
          unitPrices.sort((a,b)=>b-a);
          for (let i=0;i<unitPrices.length; i+=2){
            const p2 = unitPrices[i+1];
            if (typeof p2 === 'number') discount += p2 * 0.5;
          }
          if (discount>0) notes.push('Mon‚ÄìWed BOGO 50% on pizzas applied');
        }
      }

      // Thu‚ÄìSat: Free breadsticks with any Get Stuffed deal (max 4 per order)
      if (day>=4 && day<=6){
        const hasDealQty = state.cart.reduce((s,l)=> s + ((l.type==='deal')?l.qty:0), 0);
        if (hasDealQty>0){
          const bread = state.cart.find(l=>l.id==='ex-bread' || /breadsticks/i.test(l.name));
          if (bread){
            const freeQty = Math.min(4, bread.qty);
            if (freeQty>0){
              discount += freeQty * bread.unitPrice;
              notes.push(`Thu‚ÄìSat free breadsticks (${freeQty}) with Get Stuffed`);
            }
          }
        }
      }

      // Sunday: Pizza Saver Sunday $50 off per saver
      if (day===0 && state.pizzaSavers>0){
        const saverDiscount = 50 * state.pizzaSavers;
        discount += saverDiscount;
        notes.push(`Pizza Saver Sunday: ${state.pizzaSavers}√ó$50`);
      }

      return { discount: +(discount.toFixed(2)), notes };
    }

    // ---------- Totals ----------
    function renderTotals(){
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const deliveryFee = state.fulfillment==='delivery' ? (ZONE_FEES[state.deliveryZone]||0) : 0;
      const total = subtotal + deliveryFee - manual - promo.discount;

      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('discount').textContent = `-${currency(manual)}`;
      document.getElementById('promotions').textContent = `-${currency(promo.discount)}`;
      document.getElementById('total').textContent = currency(total);
      document.getElementById('promoNotes').textContent = promo.notes.join(' ‚Ä¢ ');
      const row = document.getElementById('deliveryRow');
      if (deliveryFee>0){ row.style.display='flex'; document.getElementById('deliveryFee').textContent = currency(deliveryFee); }
      else { row.style.display='none'; document.getElementById('deliveryFee').textContent = currency(0); }
    }

    // ---------- Discount slider ----------
    const range = document.getElementById('discountRange');
    const discountLabel = document.getElementById('discountLabel');
    function renderDiscount(){ range.value = state.discountPct; discountLabel.textContent = `${state.discountPct}%`; }
    range.addEventListener('input', ()=>{ state.discountPct = +range.value; persist(); renderTotals(); discountLabel.textContent = `${state.discountPct}%`; });

    // ---------- History ----------
    function ordersServedCounters(){
      const todayStr = new Date().toDateString();
      const today = state.history.filter(h=> new Date(h.id).toDateString() === todayStr).length;
      const overall = state.history.length;
      document.getElementById('ordersToday').textContent = today;
      document.getElementById('ordersOverall').textContent = overall;
    }

    function renderHistory(){
      ordersServedCounters();
      const list = document.getElementById('historyList');
      if (!state.history.length){ list.innerHTML = '<div class="muted">No past orders yet. Checkout to save one.</div>'; return; }
      list.innerHTML = state.history.map(h=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>${new Date(h.id).toLocaleString()}</strong></div>
              <div class="small">${h.items.length} item(s) ‚Ä¢ Discount ${h.discountPct}%</div>
            </div>
            <div><strong>${currency(h.total)}</strong></div>
          </div>
          <details class="small" style="margin-top:6px;">
            <summary>View items</summary>
            <ul style="margin:6px 0 0 16px;">
              ${h.items.map(i=>`<li>${i.qty}√ó ${i.name}${i.meta?` <span class=small>(${i.meta})</span>`:''} ‚Äî ${currency(i.lineTotal)}</li>`).join('')}
            </ul>
          </details>
          <div class="toolrow" style="justify-content:flex-end;">
            <button class="btn" data-reorder="${h.id}">Reorder</button>
            <button class="btn ghost" data-delete="${h.id}">Delete</button>
          </div>
        </article>
      `).join('');

      list.querySelectorAll('[data-reorder]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = +btn.getAttribute('data-reorder');
        const h = state.history.find(x=>x.id===id); if(!h) return;
        h.items.forEach(it => addToCart({ id: it.id || null, name: it.name, unitPrice: it.unit, qty: it.qty, meta: it.meta || null, combo: it.combo || null, drinks: it.drinks || null }));
      }));
      list.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click',()=>{
        const id = +btn.getAttribute('data-delete');
        state.history = state.history.filter(x=>x.id!==id); persistHistory(); renderHistory();
      }));
    }
    document.getElementById('clearHistoryBtn').addEventListener('click',()=>{ if(confirm('Clear all saved orders?')){ state.history=[]; persistHistory(); renderHistory(); ordersServedCounters(); } });

    // ---------- Tabs ----------
    const tabButtons = document.querySelectorAll('[data-tab]');
    function selectTab(which){
      document.getElementById('tab-summary').hidden = which!== 'summary';
      document.getElementById('tab-history').hidden = which!== 'history';
      document.getElementById('tab-ingredients').hidden = which!== 'ingredients';
      document.getElementById('tab-loyalty').hidden = which!== 'loyalty';
      tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('data-tab')===which)));
      if (which==='ingredients') renderIngredients();
      if (which==='history') ordersServedCounters();
      if (which==='loyalty') loyaltyRenderAll();
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>selectTab(b.getAttribute('data-tab'))));

    // ---------- Combo/Bundle Wizard ----------
    const comboModal = document.getElementById('comboModal');
    const comboTitle = document.getElementById('comboTitle');
    const comboSteps = document.getElementById('comboSteps');
    const comboContent = document.getElementById('comboContent');
    const comboPrev = document.getElementById('comboPrev');
    const comboNext = document.getElementById('comboNext');
    document.getElementById('closeCombo').addEventListener('click', ()=> comboModal.close());

    // FIXED: loyalty vs paid items, and specialty surcharge
    function openComboWizard(item, qty){
      const pizzasNeeded = item.pizzasIncluded || 0;
      const drinksNeeded = item.drinksIncluded || 0;
      const pizzaPool = getPizzaPool(item.allow || 'classic');
      const drinkPool = getDrinkPool();

      const pizzaCounts = {};
      const drinkCounts = {};
      let step = pizzasNeeded>0 ? 0 : (drinksNeeded>0 ? 1 : 2); // 0=pizzas, 1=drinks, 2=confirm

      const renderSteps = ()=>{
        const parts = [];
        if (pizzasNeeded>0) parts.push(step===0?'<strong>1. Pizzas</strong>':'1. Pizzas');
        if (drinksNeeded>0) parts.push(step===1?'<strong>2. Drinks</strong>':'2. Drinks');
        parts.push(step===2?'<strong>3. Confirm</strong>':'3. Confirm');
        comboSteps.innerHTML = parts.join(' ¬∑ ');
      };

      const renderGrid = (pool, counts, needed, label)=>{
        const used = Object.values(counts).reduce((a,b)=>a+b,0);
        const remaining = needed - used;
        comboTitle.textContent = `${label} ‚Äî pick ${needed} (remaining ${Math.max(0,remaining)})`;
        comboContent.innerHTML = `
          <div class="selector-grid">
            ${pool.map(p=>`
              <div class="select-card" data-id="${p.id}">
                <div class="select-title">${p.name}</div>
                <div class="select-qty">
                  <button data-minus="${p.id}">‚àí</button>
                  <output data-out="${p.id}">${counts[p.id]||0}</output>
                  <button data-plus="${p.id}">+</button>
                </div>
              </div>`).join('')}
          </div>
        `;
        comboContent.querySelectorAll('[data-plus]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const id = btn.getAttribute('data-plus');
            const currentUsed = Object.values(counts).reduce((a,b)=>a+b,0);
            if (currentUsed < needed){ counts[id]=(counts[id]||0)+1; comboContent.querySelector(`[data-out="${id}"]`).value = counts[id]; renderGrid(pool, counts, needed, label); }
          });
        });
        comboContent.querySelectorAll('[data-minus]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const id = btn.getAttribute('data-minus');
            counts[id]=Math.max(0,(counts[id]||0)-1);
            comboContent.querySelector(`[data-out="${id}"]`).value = counts[id];
            renderGrid(pool, counts, needed, label);
          });
        });
        comboPrev.style.display = step>0 ? 'inline-flex' : 'none';
        comboNext.textContent = 'Next';
        comboNext.disabled = remaining>0;
      };

      const renderConfirm = ()=>{
        comboTitle.textContent = item.name || 'Confirm Selection';
        const fmtName = (id)=> (findMenuItem(id)||{}).name?.replace(/^[^ ]+ /,'') || id;
        const pizzaList = Object.entries(pizzaCounts).filter(([,c])=>c>0).map(([id,c])=>`${fmtName(id)} x${c}`);
        const drinkList = Object.entries(drinkCounts).filter(([,c])=>c>0).map(([id,c])=>`${fmtName(id)} x${c}`);
        const info = (findMenuItem(item.id)?.description)||'';
        comboContent.innerHTML = `
          <div class="summary" style="gap:10px;">
            ${pizzaList.length?`<div><strong>Pizzas:</strong> ${pizzaList.join(', ')}</div>`:''}
            ${drinkList.length?`<div><strong>Drinks:</strong> ${drinkList.join(', ')}</div>`:''}
            ${info?`<div class="small muted">${info}</div>`:''}
          </div>
        `;
        comboPrev.style.display = (drinksNeeded>0 || pizzasNeeded>0) ? 'inline-flex' : 'none';
        comboNext.textContent = 'Add to Cart';
        comboNext.disabled = false;
      };

      const toArrayByCounts = (counts)=> Object.entries(counts).flatMap(([id,c])=> Array(c).fill(id));

      comboPrev.onclick = ()=>{ if (step>0){ step--; rerender(); } };
      comboNext.onclick = ()=>{
        if (step===0){
          step = drinksNeeded>0 ? 1 : 2; rerender(); return;
        }
        if (step===1){ step=2; rerender(); return; }

        // step === 2 -> finalize
        const pizzaIds = toArrayByCounts(pizzaCounts);
        const drinksObj = Object.fromEntries(Object.entries(drinkCounts).filter(([,c])=>c>0));

        const fmtName = (id)=> (findMenuItem(id)||{}).name?.replace(/^[^ ]+ /,'') || id;
        const pizzaNames = pizzaIds.map(fmtName);
        const drinkParts = Object.entries(drinksObj).map(([id,c])=>`${fmtName(id)} x${c}`);

        const metaParts = [];
        if (pizzaNames.length){
          const counts = pizzaNames.reduce((a,n)=>(a[n]=(a[n]||0)+1,a),{});
          metaParts.push(`Pizzas: ${Object.entries(counts).map(([n,c])=>`${n} x${c}`).join(' + ')}`);
        }
        if (drinkParts.length) metaParts.push(`Drinks: ${drinkParts.join(', ')}`);
        const meta = metaParts.join(' ‚Ä¢ ');

        // Loyalty reward (free)
        if (item.id === 'loy-reward'){
          addToCart({
            id:item.id,
            name:item.name || 'üéÅ Loyalty Reward: Large Meal',
            unitPrice: 0,
            qty: 1,
            type:'bundle',
            combo: pizzaIds,
            drinks: drinksObj,
            meta: meta + ' ‚Ä¢ Loyalty free'
          });
          addToCart({ id:'ex-bread', name:'üßÑ Breadsticks (Reward)', unitPrice:0, qty:2, type:'extra', meta:'Loyalty free' });
          comboModal.close();
          selectTab('summary');
          return;
        }

        // Paid items (deals/packs/bundles)
        let unitPrice = item.price || 0;
        if (item.allow === 'both' && item.surchargeSpecialty){
          const specialtyCount = pizzaIds.filter(pid => isSpecialtyId(pid)).length;
          unitPrice += specialtyCount * item.surchargeSpecialty;
        }

        addToCart({
          id: item.id,
          name: item.name,
          unitPrice,
          qty: qty || 1,
          type: item.type,
          combo: pizzaIds,
          drinks: drinksObj,
          meta
        });

        comboModal.close();
        selectTab('summary');
      };

      function rerender(){
        renderSteps();
        if (step===0){
          const label = (item.allow==='specialty' ? 'Specialty Pizzas' :
                        (item.allow==='both' ? 'Classic or Specialty Pizzas' : 'Classic Pizzas'));
          renderGrid(pizzaPool, pizzaCounts, pizzasNeeded, label);
        } else if (step===1){
          renderGrid(drinkPool, drinkCounts, drinksNeeded, 'Drinks');
        } else {
          renderConfirm();
        }
      }

      rerender();
      comboModal.showModal();
    }

    // ---------- Ingredients Aggregation ----------
    function aggregateIngredients(){
      const tally = {};
      const add = (name, n=1)=>{ if(!name) return; tally[name] = (tally[name]||0)+n; };

      const addDough = (units)=>{ add('Olive Oil', 1*units); add('Flour', 1*units); add('Yeast', 1*units); };
      const applyRecipe = (recipeDict, qty)=>{
        Object.entries(recipeDict).forEach(([ing,count])=>{
          if (ing === 'Dough') { addDough(count*qty); }
          else { add(ing, count*qty); }
        });
      };

      state.cart.forEach(line=>{
        if(line.type==='pizza' && line.id && RECIPE_MAP[line.id]){
          applyRecipe(RECIPE_MAP[line.id], line.qty);
        } else if ((line.type==='bundle' || line.type==='deal') && Array.isArray(line.combo) && line.combo.length){
          line.combo.forEach(pid=>{
            if (RECIPE_MAP[pid]) applyRecipe(RECIPE_MAP[pid], line.qty);
          });
          if (line.id==='bd-pack') add('Lunch Box', line.qty);
        } else if(line.id && RECIPE_MAP[line.id]){
          applyRecipe(RECIPE_MAP[line.id], line.qty);
        }
      });
      return tally;
    }

    function renderIngredients(){
      const wrap = document.getElementById('ingredientList');
      const tally = aggregateIngredients();
      const entries = Object.entries(tally).sort((a,b)=> a[0].localeCompare(b[0]));
      if(entries.length===0){ wrap.innerHTML = '<div class="muted">No ingredients yet. Add items to the cart.</div>'; return; }
      wrap.innerHTML = entries.map(([name,count])=>`<div class="ing-list"><div>${name}</div><div><strong>x${count}</strong></div></div>`).join('');
    }

    // Copy / Export actions
    document.getElementById('copyIngBtn').addEventListener('click',()=>{
      const tally = aggregateIngredients();
      const txt = Object.entries(tally).sort((a,b)=>a[0].localeCompare(b[0])).map(([n,c])=>`- ${n} x${c}`).join('\n');
      navigator.clipboard.writeText(txt).then(()=> alert('Ingredients copied to clipboard!'));
    });

    document.getElementById('exportIngBtn').addEventListener('click',()=>{
      const tally = aggregateIngredients();
      const rows = [['Ingredient','Count'], ...Object.entries(tally).sort((a,b)=>a[0].localeCompare(b[0]))];
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ingredients.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // ---------- Discount, Saver & Tabs ----------
    function renderAll(){ renderCards(); renderCart(); renderFulfillment(); renderPizzaSaver(); renderTotals(); renderDiscount(); renderHistory(); }

    // ---------- Checkout / Reset ----------
    function checkout(){
      if (!state.cart.length){ alert('Your order is empty.'); return; }
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const deliveryFee = state.fulfillment==='delivery' ? (ZONE_FEES[state.deliveryZone]||0) : 0;
      const total = +(subtotal + deliveryFee - manual - promo.discount).toFixed(2);
      const entry = {
        id: Date.now(),
        items: state.cart.map(l=>({ id: l.id || null, name: l.name, qty: l.qty, unit: l.unitPrice, meta: l.meta||null, combo: l.combo||null, drinks: l.drinks||null, lineTotal:+(l.unitPrice*l.qty).toFixed(2) })),
        discountPct: state.discountPct,
        subtotal:+subtotal.toFixed(2),
        deliveryFee,
        promoDiscount: promo.discount,
        manualDiscount: manual,
        pizzaSavers: state.pizzaSavers,
        total
      };
      state.history.unshift(entry); persistHistory();

      state.cart = [];
      state.discountPct = 0;
      state.pizzaSavers = 0;
      persist();
      renderAll();
      // Auto-start a new visit after checkout
      newVisit(true);
      selectTab('summary');
    }
    function resetAll(){
      state.cart = [];
      state.discountPct = 0;
      state.pizzaSavers = 0;
      persist(); renderAll(); renderIngredients();
    }

    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('checkoutBtn2').addEventListener('click', checkout);
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('resetBtn2').addEventListener('click', resetAll);

    // ---------- Theme ----------
    const themeBtn = document.getElementById('themeBtn');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('pizza_theme', t);
      themeBtn.textContent = t==='dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      themeBtn.setAttribute('aria-pressed', t==='dark');
    }
    applyTheme(localStorage.getItem('pizza_theme') || 'light');
    themeBtn.addEventListener('click',()=>{ const next = (localStorage.getItem('pizza_theme')||'light')==='light' ? 'dark' : 'light'; applyTheme(next); });

    // ---------- LOYALTY (Cloud sync to your Google Apps Script) ----------
    const API_URL = 'https://script.google.com/macros/s/AKfycbzV2Rm1bdRN6Be_qBPMoGmXORVG8rRBLTeAnS_agrKm-nxRUNQr9smsozc3CviAynvrjQ/exec';

    const REQUIRED_PUNCHES = 10; // 10th is free
    const DAILY_LIMIT_HOURS = 0; // disable time cooldown

    const loy = {
      els: {
        id: document.getElementById('loy-player'),
        add: document.getElementById('loy-add'),
        undo: document.getElementById('loy-undo'),
        redeem: document.getElementById('loy-redeem'),
        tray: document.getElementById('loy-tray'),
        body: document.getElementById('loy-body'),
        stats: document.getElementById('loy-stats'),
        status: document.getElementById('loy-status'),
        dp: document.getElementById('dpStatus'),
        exportBtn: document.getElementById('loy-export'),
        visitInfo: document.getElementById('visitInfo'),
        newVisitBtn: document.getElementById('newVisitBtn'),
      },
      players: {},
      currentId: null,
      visitId: Number(localStorage.getItem('pizzathis_visit_id') || '1'),
      visitPunched: JSON.parse(localStorage.getItem('pizzathis_visit_punched') || '[]'),
    };

    function saveVisit(){
      localStorage.setItem('pizzathis_visit_id', String(loy.visitId));
      localStorage.setItem('pizzathis_visit_punched', JSON.stringify(loy.visitPunched));
      loy.els.visitInfo.textContent = `#${loy.visitId} ‚Ä¢ ${loy.visitPunched.length} punched`;
    }
    function newVisit(auto=false){
      if (!auto && !confirm('Start a new visit? (resets per-visit punch limit)')) return;
      loy.visitId += 1;
      loy.visitPunched = [];
      saveVisit();
      loySetStatus(`Visit #${loy.visitId} started. Per-visit limits reset.`, true);
    }
    saveVisit();
    loy.els.newVisitBtn.addEventListener('click', ()=> newVisit(false));

    function isDoubleTuesday(){ return new Date().getDay() === 2; } // all Tuesday

    function loySetStatus(msg, ok=true){
      loy.els.status.innerHTML = `<span style="font-weight:700;${ok?'color:#1a7f37':'color:#b71c1c'}">${ok?'‚úì':'‚úó'}</span> ${msg}`;
    }
    function loyUpdateDPLabel(){
      const active = isDoubleTuesday();
      loy.els.dp.textContent = `Double Punch Tuesday: ${active ? 'ACTIVE all day' : 'auto all day on Tuesdays'}`;
      loy.els.dp.style.fontWeight = active ? '700' : '400';
    }
    setInterval(loyUpdateDPLabel, 30_000); loyUpdateDPLabel();

    // ---------- FIXED API: send RAW JSON for POST (no payload=...) ----------
    async function api(method, body){
      const url = API_URL + '?m=' + encodeURIComponent(method);

      if (method === 'list') {
        const res = await fetch(url, { method:'GET' });
        const txt = await res.text();
        let data = {};
        try { data = JSON.parse(txt); } catch {}
        if (!res.ok || (data && data.ok === false)) {
          const msg = data && data.error ? data.error : `HTTP ${res.status} ${res.statusText}`;
          throw new Error(msg);
        }
        return data;
      }

      // POST: raw JSON body, NO headers -> text/plain (simple request)
      const res = await fetch(url, {
        method: 'POST',
        body: JSON.stringify(body || {})
      });

      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch {}
      if (!res.ok || (data && data.ok === false)) {
        const msg = data && data.error ? data.error : `HTTP ${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return data;
    }

    function loyRenderTray(player){
      loy.els.tray.innerHTML = '';
      const punches = player ? (player.punches||0) : 0;
      for(let i=0;i<REQUIRED_PUNCHES;i++){
        const div = document.createElement('div');
        div.className = 'chipbox' + (i < punches ? ' filled':'' ) + (i===REQUIRED_PUNCHES-1 ? ' free':'');
        div.textContent = i < punches ? 'üçï' : (i===REQUIRED_PUNCHES-1 ? 'FREE' : 'üçï');
        loy.els.tray.appendChild(div);
      }
    }

    function loyRenderTable(){
      const entries = Object.entries(loy.players);
      loy.els.body.innerHTML = entries.map(([id,p])=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${id}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.punches||0}/${REQUIRED_PUNCHES}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.rewards||0}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${p.last? new Date((p.last)*1000).toLocaleString() : '‚Äî'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)"><button class="btn" data-loyload="${id}">Load</button></td>
        </tr>`).join('');
      loy.els.body.querySelectorAll('[data-loyload]').forEach(b=>b.addEventListener('click',()=>{
        loy.currentId = b.getAttribute('data-loyload');
        loy.els.id.value = loy.currentId;
        loyRenderTray(loy.players[loy.currentId]||null);
      }));
      const totalRewards = entries.reduce((a,[,p])=> a + (p.rewards||0), 0);
      loy.els.stats.textContent = `Players: ${entries.length} ‚Ä¢ Rewards banked: ${totalRewards}`;
    }

    async function loyaltyLoad(){
      try{
        const data = await api('list');
        loy.players = data.players || {};
        loySetStatus('Cloud sync: loaded.', true);
      }catch(e){
        loySetStatus('Cloud error. Check deployment access.', false);
      }
      loyRenderTable();
      loyRenderTray(loy.currentId ? loy.players[loy.currentId] : null);
    }

    async function loyaltyAddPunch(){
      const id = (loy.els.id.value||'').trim();
      if(!id) return loySetStatus('Enter a player name.', false);
      // Once-per-visit protection
      if (loy.visitPunched.includes(id)) {
        return loySetStatus('This player already got a punch this visit. Start a New Visit to punch again.', false);
      }
      const inc = isDoubleTuesday() ? 2 : 1;
      try{
        const out = await api('punch', { id, inc, cooldownHours: DAILY_LIMIT_HOURS, required: REQUIRED_PUNCHES });
        if (out.error && out.error==='cooldown') {
          return loySetStatus('Server cooldown hit. Try again later or disable cooldown in script.', false);
        }
        loy.players[id] = out.player;
        loy.currentId = id;
        loy.visitPunched.push(id);
        saveVisit();
        loySetStatus(`Punch added (${(out.player.punches||0)}/${REQUIRED_PUNCHES}).${inc===2?' (Double Tuesday!)':''}`, true);
      }catch(e){
        loySetStatus('Failed to add punch (network?).', false);
      }
      loyRenderTable(); loyRenderTray(loy.players[id]);
    }

    async function loyaltyUndo(){
      const id = (loy.els.id.value||'').trim();
      if(!id) return loySetStatus('Enter a player id.', false);
      try{
        const out = await api('undo', { id });
        loy.players[id] = out.player;
        loy.currentId = id;
        // Allow re-punch in this visit after undo
        loy.visitPunched = loy.visitPunched.filter(x=>x!==id);
        saveVisit();
        loySetStatus('Removed one punch.', true);
      }catch(e){
        loySetStatus('Failed to remove punch.', false);
      }
      loyRenderTable(); loyRenderTray(loy.players[id]);
    }

    function openRewardWizard(){
      const item = {
        id:'loy-reward',
        name:'üéÅ Loyalty Reward: Large Meal',
        price:0, type:'bundle',
        pizzasIncluded:2, drinksIncluded:8, allow:'both'
      };
      openComboWizard(item, 1);
    }

    async function loyaltyRedeem(){
      const id = (loy.els.id.value||'').trim();
      if(!id) return loySetStatus('Enter a player id.', false);
      try{
        const out = await api('redeem', { id });
        if(out.error){ loySetStatus('No rewards banked for this player.', false); return; }
        loy.players[id] = out.player;
        loy.currentId = id;
        loySetStatus('Reward redeemed! Pick your free meal.', true);
        openRewardWizard();
      }catch(e){
        loySetStatus('Failed to redeem reward.', false);
      }
      loyRenderTable(); loyRenderTray(loy.players[id]);
    }

    function loyaltyExport(){
      const blob = new Blob([JSON.stringify({players:loy.players},null,2)],{type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pizzathis_loyalty_backup.json'; a.click();
    }

    function loyaltyBind(){
      loy.els.add.addEventListener('click', loyaltyAddPunch);
      loy.els.undo.addEventListener('click', loyaltyUndo);
      loy.els.redeem.addEventListener('click', loyaltyRedeem);
      loy.els.exportBtn.addEventListener('click', loyaltyExport);
    }
    function loyaltyRenderAll(){
      loyaltyLoad();
    }

    // ---------- Init ----------
    renderAll();
    loyaltyBind();
  </script>
</body>
</html>
